# 哨兵机制

哨兵会定时ping主从节点, 当发现主节点挂掉, 就定该情况为`主观下线`. 然后会问其他哨兵master情况, 其他哨兵认定进行投票, 如果投票数超过设定的`quorum`, 就认定为`客观下线`.

这时候要选一个哨兵对节点进行主从转移. 哪个哨兵节点判断主节点为「客观下线」，这个哨兵节点就是候选者，所谓的候选者就是想当 Leader 的哨兵。举个例子，假设有三个哨兵。当哨兵 B 先判断到主节点「主观下线后」，就会给其他实例发送 is-master-down-by-addr 命令。接着，其他哨兵会根据自己和主节点的网络连接情况，做出赞成投票或者拒绝投票的响应。当哨兵 B 收到赞成票数达到哨兵配置文件中的 quorum 配置项设定的值后，就会将主节点标记为「客观下线」，此时的哨兵 B 就是一个 Leader 候选者。

然后哨兵会选一个从节点当主节点. 选哪个呢? 四个标准:

1. 剔除网络不好的节点: Redis 有个叫 down-after-milliseconds * 10 配置项，其down-after-milliseconds 是主从节点断连的最大连接超时时间。超过就不行
2. 优先级: 优先级高的节点优先, 优先级可通过配置设置
3. 复制进度: 从节点复制进度越高越好
4. ID号: ID号越小越好

## reference

[link](https://www.xiaolincoding.com/redis/cluster/sentinel.html#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E6%9C%89%E5%93%A8%E5%85%B5%E6%9C%BA%E5%88%B6)