# 消息队列

## 作用

系统解耦, 流量控制. 系统解耦会带来数据一致性完整性问题, 流量控制会带来消费端或生产端信息积压问题. 

## 数据完整性

如何知道有消息丢失? -> 哪些消息会丢失 -> 如何确保消息不丢失

基本阶段做下面三个事情:

![48](/Image/system_design/48.png)

但是这些在分布式事务中还不够, 本着design for failure的原则, 一定要考虑消息丢失的情况.

所以可以用一个全局唯一id, 赋给每个消息, 消费端消费完消息后, 通过这个id来确认消息是否被消费, 具体:

![48](/Image/system_design/49.png)

## 重复消费问题

![48](/Image/system_design/50.png)

最简单方法就是通过数据库:

![48](/Image/system_design/51.png)

举例, 业务操作可以放到数据库里面, 先数据库插入一条数据, 再通过数据库进行后续异步业务操作. 数据库也可以是redis. 同样得, 消息需要有一个全局唯一id


## 消息积压问题

给面试官引导, 消息积压一定是性能问题, 一般是扩容或者降级

扩容消费者实例的时候, 必须同步扩容主题topic数量, 因为是单线程